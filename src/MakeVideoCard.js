import { useState, useEffect } from 'react'
import VideoFetcher from './VideoFetcher'

const { REACT_APP_API_URL } = process.env

const testCData = `{"strokes":[{"size":74,"style":"dot","paintStyle":"draw","points":[{"x":0.5013888888888889,"y":0.6636125654450262},{"x":0.5013888888888889,"y":0.6636125654450262},{"x":0.49583333333333335,"y":0.6636125654450262},{"x":0.4930555555555556,"y":0.6636125654450262},{"x":0.4888888888888889,"y":0.662303664921466},{"x":0.4861111111111111,"y":0.6609947643979057},{"x":0.4791666666666667,"y":0.6583769633507853},{"x":0.4736111111111111,"y":0.6557591623036649},{"x":0.4666666666666667,"y":0.6518324607329843},{"x":0.46111111111111114,"y":0.6492146596858639},{"x":0.44722222222222224,"y":0.6413612565445026},{"x":0.43472222222222223,"y":0.6335078534031413},{"x":0.41944444444444445,"y":0.6230366492146597},{"x":0.4041666666666667,"y":0.6099476439790575},{"x":0.39166666666666666,"y":0.5955497382198953},{"x":0.3763888888888889,"y":0.5785340314136126},{"x":0.3638888888888889,"y":0.5615183246073299},{"x":0.3541666666666667,"y":0.5431937172774869},{"x":0.34444444444444444,"y":0.5222513089005235},{"x":0.33194444444444443,"y":0.48429319371727747},{"x":0.3277777777777778,"y":0.44502617801047123},{"x":0.3277777777777778,"y":0.42670157068062825},{"x":0.3277777777777778,"y":0.40706806282722513},{"x":0.3277777777777778,"y":0.387434554973822},{"x":0.32916666666666666,"y":0.3704188481675393},{"x":0.35138888888888886,"y":0.31282722513089006},{"x":0.3625,"y":0.29450261780104714},{"x":0.3861111111111111,"y":0.2591623036649215},{"x":0.39444444444444443,"y":0.2486910994764398},{"x":0.4111111111111111,"y":0.22774869109947643},{"x":0.42916666666666664,"y":0.2081151832460733},{"x":0.4486111111111111,"y":0.18848167539267016},{"x":0.4861111111111111,"y":0.15575916230366493},{"x":0.4986111111111111,"y":0.14790575916230367},{"x":0.5236111111111111,"y":0.13350785340314136},{"x":0.55,"y":0.12172774869109948},{"x":0.5736111111111111,"y":0.11387434554973822},{"x":0.5958333333333333,"y":0.10863874345549739},{"x":0.6152777777777778,"y":0.10602094240837696},{"x":0.6555555555555556,"y":0.10471204188481675},{"x":0.675,"y":0.10471204188481675},{"x":0.7097222222222223,"y":0.112565445026178},{"x":0.7333333333333333,"y":0.1256544502617801},{"x":0.7597222222222222,"y":0.14397905759162305},{"x":0.7847222222222222,"y":0.1649214659685864},{"x":0.8319444444444445,"y":0.21335078534031413},{"x":0.8430555555555556,"y":0.22643979057591623},{"x":0.8625,"y":0.2513089005235602},{"x":0.8805555555555555,"y":0.2774869109947644},{"x":0.8958333333333334,"y":0.3023560209424084},{"x":0.9069444444444444,"y":0.32460732984293195},{"x":0.9166666666666666,"y":0.34554973821989526},{"x":0.925,"y":0.36518324607329844},{"x":0.9375,"y":0.40706806282722513},{"x":0.9416666666666667,"y":0.42670157068062825},{"x":0.9430555555555555,"y":0.4463350785340314},{"x":0.9444444444444444,"y":0.46465968586387435},{"x":0.9458333333333333,"y":0.4856020942408377},{"x":0.9458333333333333,"y":0.5287958115183246},{"x":0.9402777777777778,"y":0.5510471204188482},{"x":0.9263888888888889,"y":0.5916230366492147},{"x":0.9194444444444444,"y":0.6047120418848168},{"x":0.8958333333333334,"y":0.6479057591623036},{"x":0.8763888888888889,"y":0.6727748691099477},{"x":0.8541666666666666,"y":0.6976439790575916},{"x":0.8291666666666667,"y":0.7212041884816754},{"x":0.8013888888888889,"y":0.743455497382199},{"x":0.7361111111111112,"y":0.7827225130890052},{"x":0.6875,"y":0.8023560209424084},{"x":0.6555555555555556,"y":0.8115183246073299},{"x":0.6013888888888889,"y":0.8259162303664922},{"x":0.5875,"y":0.8259162303664922},{"x":0.5583333333333333,"y":0.8298429319371727},{"x":0.5083333333333333,"y":0.831151832460733},{"x":0.47638888888888886,"y":0.831151832460733},{"x":0.46111111111111114,"y":0.831151832460733},{"x":0.4083333333333333,"y":0.8219895287958116},{"x":0.39305555555555555,"y":0.8167539267015707},{"x":0.36666666666666664,"y":0.8075916230366492},{"x":0.33611111111111114,"y":0.7931937172774869},{"x":0.2902777777777778,"y":0.768324607329843},{"x":0.2791666666666667,"y":0.7591623036649214},{"x":0.25555555555555554,"y":0.7408376963350786},{"x":0.2222222222222222,"y":0.7081151832460733},{"x":0.2152777777777778,"y":0.6963350785340314},{"x":0.19305555555555556,"y":0.6583769633507853},{"x":0.1875,"y":0.643979057591623},{"x":0.17083333333333334,"y":0.5981675392670157},{"x":0.16527777777777777,"y":0.569371727748691},{"x":0.16527777777777777,"y":0.5536649214659686},{"x":0.16111111111111112,"y":0.4986910994764398},{"x":0.16111111111111112,"y":0.46727748691099474},{"x":0.16111111111111112,"y":0.45287958115183247},{"x":0.16527777777777777,"y":0.42277486910994766},{"x":0.1736111111111111,"y":0.39659685863874344},{"x":0.18194444444444444,"y":0.3730366492146597},{"x":0.19166666666666668,"y":0.3507853403141361},{"x":0.20416666666666666,"y":0.331151832460733},{"x":0.24444444444444444,"y":0.27486910994764396},{"x":0.25416666666666665,"y":0.2643979057591623},{"x":0.2722222222222222,"y":0.24345549738219896},{"x":0.30972222222222223,"y":0.2054973821989529},{"x":0.31666666666666665,"y":0.19895287958115182},{"x":0.33055555555555555,"y":0.18979057591623036},{"x":0.3527777777777778,"y":0.17408376963350786},{"x":0.36666666666666664,"y":0.16753926701570682},{"x":0.3819444444444444,"y":0.16361256544502617},{"x":0.39861111111111114,"y":0.16230366492146597},{"x":0.43472222222222223,"y":0.16230366492146597},{"x":0.4638888888888889,"y":0.1649214659685864},{"x":0.49166666666666664,"y":0.17539267015706805},{"x":0.525,"y":0.19240837696335078},{"x":0.5583333333333333,"y":0.2107329842931937},{"x":0.5902777777777778,"y":0.23167539267015708},{"x":0.6027777777777777,"y":0.24345549738219896},{"x":0.6277777777777778,"y":0.2630890052356021},{"x":0.6527777777777778,"y":0.2905759162303665},{"x":0.6638888888888889,"y":0.30497382198952877},{"x":0.675,"y":0.3193717277486911},{"x":0.6805555555555556,"y":0.331151832460733},{"x":0.6888888888888889,"y":0.35471204188481675},{"x":0.6902777777777778,"y":0.3704188481675393},{"x":0.6916666666666667,"y":0.39790575916230364},{"x":0.6916666666666667,"y":0.42277486910994766},{"x":0.6888888888888889,"y":0.4489528795811518},{"x":0.6805555555555556,"y":0.47774869109947643},{"x":0.6736111111111112,"y":0.49345549738219896},{"x":0.6611111111111111,"y":0.518324607329843},{"x":0.6458333333333334,"y":0.5418848167539267},{"x":0.6305555555555555,"y":0.5615183246073299},{"x":0.6138888888888889,"y":0.581151832460733},{"x":0.6041666666666666,"y":0.5903141361256544},{"x":0.5,"y":0.6544502617801047},{"x":0.4777777777777778,"y":0.6596858638743456},{"x":0.4597222222222222,"y":0.6649214659685864},{"x":0.425,"y":0.6727748691099477},{"x":0.40694444444444444,"y":0.6740837696335078},{"x":0.375,"y":0.6767015706806283},{"x":0.34444444444444444,"y":0.6767015706806283},{"x":0.31805555555555554,"y":0.6767015706806283},{"x":0.2972222222222222,"y":0.6740837696335078},{"x":0.28194444444444444,"y":0.6662303664921466},{"x":0.26666666666666666,"y":0.6557591623036649},{"x":0.25555555555555554,"y":0.6465968586387435},{"x":0.24722222222222223,"y":0.6335078534031413},{"x":0.2388888888888889,"y":0.6178010471204188},{"x":0.23333333333333334,"y":0.6020942408376964},{"x":0.23194444444444445,"y":0.5929319371727748},{"x":0.22777777777777777,"y":0.5759162303664922},{"x":0.225,"y":0.56282722513089},{"x":0.22361111111111112,"y":0.5392670157068062},{"x":0.22361111111111112,"y":0.5287958115183246},{"x":0.22361111111111112,"y":0.5143979057591623}]}],"settings":{"uniforms":{"uVertex":13,"uWidth":31.937098173881164,"uRadius":0.8976546327412245,"uSpin":0.012434246311672226,"uBias":0.724543208271832,"uVertexHeight":0.15262833386553576,"uRotationSpeed":0.018406948826565486,"uPointiness":0,"uPow":-0.2771831572692562,"uPows":0,"uLr":0},"speed":3.8237335848350584,"swatches":["Multi_Color_52","Muted_3"],"aspectRatio":0.9424083769633508},"hash":"","type":"video"}`

function VideoCard() {

  const [cData, setCData] = useState(testCData)
  const [renderId, setRenderId] = useState(null)
  const [startEndTimes, setStartEndTimes] = useState([])
  const [completed, setCompleted] = useState(false)
  const [voucher, setVoucher] = useState(null)
  const [requestClicked, setRequestClicked] = useState(false)
  const [createVoucherClicked, setCreateVoucherClicked] = useState(false)
  const [cancelClicked, setCancelClicked] = useState(false)

  useEffect(() => {
    if (!requestClicked) {
      return
    }
    async function requestRender() {
      const resp = await fetch(`${REACT_APP_API_URL}/renderVideo`, {
        method: 'POST',
        headers: {
          'Accept': 'application/json',
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ cData })
      })
      const data = await resp.json()
      setRenderId( data.renderId )
      setStartEndTimes([ Date.now() ])
    }
    requestRender()
    setRequestClicked(false)
  }, [requestClicked])

  useEffect(() => {
    if (!completed) {
      return
    }
    setStartEndTimes([ startEndTimes[0], Date.now() ])
  }, [completed])

  useEffect(() => {
    if (!cancelClicked) {
      return
    }
    setRenderId(null)
    setCompleted(false)
    setVoucher(null)
    setCancelClicked(false)
  }, [cancelClicked])

  useEffect(() => {
    if (!createVoucherClicked) {
      return
    }
    async function createVoucherRequest() {
      const resp = await fetch(`${REACT_APP_API_URL}/voucher`, {
        method: 'POST',
        headers: {
          'Accept': 'application/json',
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          renderId,
          creator: '0x200f2Ae7942F27A6cA47729D665803d42Cec31A4'
        })
      })
      const data = await resp.json()
      setVoucher(data.voucher)
    }
    createVoucherRequest()
    setCreateVoucherClicked(false)    
  }, [createVoucherClicked, renderId])

  return (
      <div className="VideoCard">
        <div className="input-row">
          cData: <textarea value={cData}  onChange={(e) => setCData(e.target.value)} />
          <button className="request-render-button" 
            disabled={requestClicked || !!renderId}
            onClick={() => setRequestClicked(true)}>Request render</button>
        </div>

        {!!renderId &&
            <VideoFetcher
              renderId={renderId}
              onComplete={() => setCompleted(true) }
              onCancel={() => setCancelClicked(true) }/>
        }
        
        { startEndTimes.length === 2 && <div> Complete time: { parseInt((startEndTimes[1] - startEndTimes[0])/1000 ) } sec </div> }

        { completed && <button onClick={() => setCreateVoucherClicked(true) }>Get voucher</button> }

        { voucher && (
          <a target="_blank" href={voucher.tokenURI.replace('ipfs://', 'https://digitalpaint.mypinata.cloud/ipfs/')}>
            {voucher.tokenURI}
          </a>
        )}

      </div>
  )
}

export default VideoCard
