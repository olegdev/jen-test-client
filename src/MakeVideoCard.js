import { useState, useEffect } from 'react'
import VideoFetcher from './VideoFetcher'

const { REACT_APP_API_URL } = process.env

const testCData = `{"strokes":[{"size":24,"style":"dot","paintStyle":"draw","points":[{"x":0.4534722222222222,"y":0.6151832460732984},{"x":0.4534722222222222,"y":0.6138743455497382},{"x":0.4527777777777778,"y":0.6086387434554974},{"x":0.45069444444444445,"y":0.599476439790576},{"x":0.4486111111111111,"y":0.5903141361256544},{"x":0.4465277777777778,"y":0.5785340314136126},{"x":0.44305555555555554,"y":0.556282722513089},{"x":0.4409722222222222,"y":0.5379581151832461},{"x":0.4409722222222222,"y":0.5143979057591623},{"x":0.4409722222222222,"y":0.49214659685863876},{"x":0.4409722222222222,"y":0.4738219895287958},{"x":0.44166666666666665,"y":0.4568062827225131},{"x":0.44513888888888886,"y":0.4410994764397906},{"x":0.44930555555555557,"y":0.42408376963350786},{"x":0.4548611111111111,"y":0.4096858638743455},{"x":0.46111111111111114,"y":0.39790575916230364},{"x":0.46805555555555556,"y":0.38612565445026176},{"x":0.4756944444444444,"y":0.3769633507853403},{"x":0.48680555555555555,"y":0.36518324607329844},{"x":0.4986111111111111,"y":0.35602094240837695},{"x":0.5145833333333333,"y":0.3481675392670157},{"x":0.5326388888888889,"y":0.3416230366492147},{"x":0.5520833333333334,"y":0.3390052356020942},{"x":0.5708333333333333,"y":0.3390052356020942},{"x":0.5847222222222223,"y":0.3390052356020942},{"x":0.6027777777777777,"y":0.34424083769633507},{"x":0.6173611111111111,"y":0.35209424083769636},{"x":0.6284722222222222,"y":0.3599476439790576},{"x":0.6388888888888888,"y":0.3704188481675393},{"x":0.6486111111111111,"y":0.38350785340314136},{"x":0.65625,"y":0.39790575916230364},{"x":0.6625,"y":0.412303664921466},{"x":0.6701388888888888,"y":0.4410994764397906},{"x":0.6715277777777777,"y":0.4607329842931937},{"x":0.6715277777777777,"y":0.4882198952879581},{"x":0.6680555555555555,"y":0.5117801047120419},{"x":0.6638888888888889,"y":0.5301047120418848},{"x":0.6548611111111111,"y":0.5667539267015707},{"x":0.6486111111111111,"y":0.5837696335078534},{"x":0.6402777777777777,"y":0.6034031413612565},{"x":0.6298611111111111,"y":0.6217277486910995},{"x":0.6201388888888889,"y":0.6361256544502618},{"x":0.6152777777777778,"y":0.6426701570680629},{"x":0.6013888888888889,"y":0.6596858638743456},{"x":0.5868055555555556,"y":0.6727748691099477},{"x":0.5784722222222223,"y":0.6793193717277487},{"x":0.5673611111111111,"y":0.6858638743455497},{"x":0.5555555555555556,"y":0.6910994764397905},{"x":0.5402777777777777,"y":0.6950261780104712},{"x":0.5263888888888889,"y":0.6963350785340314},{"x":0.5104166666666666,"y":0.6976439790575916},{"x":0.4930555555555556,"y":0.6976439790575916},{"x":0.475,"y":0.6976439790575916},{"x":0.45694444444444443,"y":0.6963350785340314},{"x":0.44375,"y":0.6897905759162304},{"x":0.42291666666666666,"y":0.6767015706806283},{"x":0.4083333333333333,"y":0.6675392670157068},{"x":0.39375,"y":0.6557591623036649},{"x":0.37916666666666665,"y":0.6426701570680629},{"x":0.36875,"y":0.6321989528795812},{"x":0.35208333333333336,"y":0.6112565445026178},{"x":0.34444444444444444,"y":0.5968586387434555},{"x":0.33611111111111114,"y":0.5798429319371727},{"x":0.3263888888888889,"y":0.5510471204188482},{"x":0.32083333333333336,"y":0.5261780104712042},{"x":0.31875,"y":0.5078534031413613},{"x":0.3173611111111111,"y":0.4725130890052356},{"x":0.3173611111111111,"y":0.44502617801047123},{"x":0.3194444444444444,"y":0.412303664921466},{"x":0.32569444444444445,"y":0.3782722513089005},{"x":0.33194444444444443,"y":0.35732984293193715},{"x":0.34305555555555556,"y":0.3206806282722513},{"x":0.3527777777777778,"y":0.29712041884816753},{"x":0.36319444444444443,"y":0.27486910994764396},{"x":0.37777777777777777,"y":0.2513089005235602},{"x":0.39375,"y":0.22643979057591623},{"x":0.4125,"y":0.19895287958115182},{"x":0.43194444444444446,"y":0.17801047120418848},{"x":0.4597222222222222,"y":0.1505235602094241},{"x":0.4777777777777778,"y":0.13612565445026178},{"x":0.49444444444444446,"y":0.1256544502617801},{"x":0.5111111111111111,"y":0.11649214659685864},{"x":0.5284722222222222,"y":0.112565445026178},{"x":0.5458333333333333,"y":0.1099476439790576},{"x":0.5638888888888889,"y":0.1099476439790576},{"x":0.58125,"y":0.1099476439790576},{"x":0.5993055555555555,"y":0.11649214659685864},{"x":0.6180555555555556,"y":0.12696335078534032},{"x":0.6354166666666666,"y":0.14136125654450263},{"x":0.6534722222222222,"y":0.15837696335078533},{"x":0.6715277777777777,"y":0.17801047120418848},{"x":0.6840277777777778,"y":0.193717277486911},{"x":0.7020833333333333,"y":0.2198952879581152},{"x":0.7138888888888889,"y":0.2395287958115183},{"x":0.7222222222222222,"y":0.25523560209424084},{"x":0.7305555555555555,"y":0.27356020942408377},{"x":0.7368055555555556,"y":0.2892670157068063},{"x":0.7416666666666667,"y":0.3023560209424084},{"x":0.7444444444444445,"y":0.31413612565445026},{"x":0.7465277777777778,"y":0.32460732984293195},{"x":0.7472222222222222,"y":0.33507853403141363},{"x":0.7472222222222222,"y":0.3494764397905759},{"x":0.7472222222222222,"y":0.36780104712041883},{"x":0.74375,"y":0.39397905759162305},{"x":0.7402777777777778,"y":0.418848167539267},{"x":0.7347222222222223,"y":0.4476439790575916},{"x":0.7263888888888889,"y":0.4803664921465969},{"x":0.7166666666666667,"y":0.5130890052356021},{"x":0.70625,"y":0.5458115183246073},{"x":0.6993055555555555,"y":0.56282722513089},{"x":0.6888888888888889,"y":0.5837696335078534},{"x":0.6763888888888889,"y":0.606020942408377},{"x":0.6694444444444444,"y":0.6151832460732984},{"x":0.6597222222222222,"y":0.6269633507853403},{"x":0.6388888888888888,"y":0.6465968586387435},{"x":0.6194444444444445,"y":0.662303664921466},{"x":0.6,"y":0.675392670157068},{"x":0.5847222222222223,"y":0.6858638743455497},{"x":0.5701388888888889,"y":0.6950261780104712},{"x":0.5444444444444444,"y":0.7107329842931938},{"x":0.5256944444444445,"y":0.7185863874345549},{"x":0.49583333333333335,"y":0.7290575916230366},{"x":0.475,"y":0.7356020942408377},{"x":0.4465277777777778,"y":0.7447643979057592},{"x":0.4215277777777778,"y":0.75},{"x":0.39861111111111114,"y":0.7539267015706806},{"x":0.38472222222222224,"y":0.7539267015706806},{"x":0.36180555555555555,"y":0.7513089005235603},{"x":0.35,"y":0.7473821989528796},{"x":0.33194444444444443,"y":0.7369109947643979},{"x":0.3173611111111111,"y":0.7277486910994765},{"x":0.3020833333333333,"y":0.7185863874345549},{"x":0.2847222222222222,"y":0.7054973821989529},{"x":0.26805555555555555,"y":0.6910994764397905},{"x":0.25277777777777777,"y":0.675392670157068},{"x":0.2375,"y":0.6583769633507853},{"x":0.22847222222222222,"y":0.6452879581151832},{"x":0.21736111111111112,"y":0.6269633507853403},{"x":0.20833333333333334,"y":0.6099476439790575},{"x":0.2,"y":0.5824607329842932},{"x":0.1951388888888889,"y":0.556282722513089},{"x":0.19305555555555556,"y":0.5287958115183246},{"x":0.19305555555555556,"y":0.4973821989528796},{"x":0.19375,"y":0.46596858638743455},{"x":0.19930555555555557,"y":0.43586387434554974},{"x":0.20694444444444443,"y":0.40706806282722513},{"x":0.21319444444444444,"y":0.387434554973822},{"x":0.22152777777777777,"y":0.36649214659685864},{"x":0.23055555555555557,"y":0.3494764397905759},{"x":0.23958333333333334,"y":0.33638743455497383},{"x":0.24861111111111112,"y":0.3285340314136126},{"x":0.25763888888888886,"y":0.32722513089005234},{"x":0.2659722222222222,"y":0.32722513089005234},{"x":0.2743055555555556,"y":0.3337696335078534},{"x":0.2826388888888889,"y":0.34554973821989526},{"x":0.29375,"y":0.36518324607329844},{"x":0.3034722222222222,"y":0.38612565445026176},{"x":0.31319444444444444,"y":0.41492146596858637},{"x":0.33055555555555555,"y":0.4594240837696335},{"x":0.3368055555555556,"y":0.4725130890052356},{"x":0.35694444444444445,"y":0.5052356020942408},{"x":0.3736111111111111,"y":0.5170157068062827},{"x":0.39375,"y":0.5235602094240838},{"x":0.4097222222222222,"y":0.524869109947644},{"x":0.43472222222222223,"y":0.524869109947644},{"x":0.4513888888888889,"y":0.5170157068062827},{"x":0.46597222222222223,"y":0.5039267015706806},{"x":0.47847222222222224,"y":0.4856020942408377},{"x":0.4861111111111111,"y":0.4698952879581152},{"x":0.49375,"y":0.4489528795811518},{"x":0.5,"y":0.4175392670157068},{"x":0.5027777777777778,"y":0.3887434554973822},{"x":0.5027777777777778,"y":0.3586387434554974},{"x":0.5,"y":0.3206806282722513},{"x":0.4875,"y":0.2617801047120419},{"x":0.4756944444444444,"y":0.22774869109947643},{"x":0.45625,"y":0.19109947643979058},{"x":0.4361111111111111,"y":0.16230366492146597},{"x":0.42430555555555555,"y":0.14790575916230367},{"x":0.41180555555555554,"y":0.13743455497382198},{"x":0.4027777777777778,"y":0.13350785340314136},{"x":0.39375,"y":0.13350785340314136},{"x":0.38263888888888886,"y":0.1387434554973822},{"x":0.375,"y":0.14790575916230367},{"x":0.3659722222222222,"y":0.16099476439790575},{"x":0.35833333333333334,"y":0.17146596858638743},{"x":0.3548611111111111,"y":0.1793193717277487},{"x":0.3506944444444444,"y":0.18717277486910994},{"x":0.3486111111111111,"y":0.1950261780104712},{"x":0.3472222222222222,"y":0.20418848167539266},{"x":0.3472222222222222,"y":0.21204188481675393},{"x":0.35,"y":0.2212041884816754},{"x":0.35694444444444445,"y":0.2342931937172775},{"x":0.3680555555555556,"y":0.24607329842931938},{"x":0.38472222222222224,"y":0.2617801047120419},{"x":0.40555555555555556,"y":0.2761780104712042},{"x":0.42777777777777776,"y":0.2931937172774869},{"x":0.44930555555555557,"y":0.3102094240837696},{"x":0.47152777777777777,"y":0.3285340314136126},{"x":0.5041666666666667,"y":0.35471204188481675},{"x":0.5513888888888889,"y":0.3887434554973822},{"x":0.5729166666666666,"y":0.40575916230366493},{"x":0.5972222222222222,"y":0.42670157068062825},{"x":0.6090277777777777,"y":0.43848167539267013},{"x":0.6222222222222222,"y":0.45287958115183247},{"x":0.63125,"y":0.46465968586387435},{"x":0.6381944444444444,"y":0.47643979057591623},{"x":0.64375,"y":0.4882198952879581},{"x":0.6486111111111111,"y":0.5},{"x":0.6527777777777778,"y":0.5130890052356021},{"x":0.6548611111111111,"y":0.5274869109947644},{"x":0.65625,"y":0.5405759162303665},{"x":0.6569444444444444,"y":0.5602094240837696},{"x":0.6569444444444444,"y":0.5772251308900523},{"x":0.6534722222222222,"y":0.5968586387434555},{"x":0.65,"y":0.612565445026178},{"x":0.6451388888888889,"y":0.6269633507853403},{"x":0.6409722222222223,"y":0.6361256544502618},{"x":0.6305555555555555,"y":0.6518324607329843},{"x":0.6208333333333333,"y":0.6662303664921466},{"x":0.6111111111111112,"y":0.675392670157068},{"x":0.5881944444444445,"y":0.7002617801047121},{"x":0.5756944444444444,"y":0.7081151832460733},{"x":0.5590277777777778,"y":0.7172774869109948},{"x":0.5458333333333333,"y":0.7225130890052356},{"x":0.5361111111111111,"y":0.7238219895287958},{"x":0.5277777777777778,"y":0.7238219895287958},{"x":0.525,"y":0.7238219895287958},{"x":0.5222222222222223,"y":0.7198952879581152},{"x":0.5201388888888889,"y":0.7172774869109948},{"x":0.5194444444444445,"y":0.7146596858638743},{"x":0.51875,"y":0.7120418848167539},{"x":0.5180555555555556,"y":0.7068062827225131},{"x":0.5173611111111112,"y":0.7002617801047121},{"x":0.5152777777777777,"y":0.6884816753926701},{"x":0.5138888888888888,"y":0.6596858638743456},{"x":0.5131944444444444,"y":0.6269633507853403},{"x":0.5131944444444444,"y":0.5903141361256544},{"x":0.5131944444444444,"y":0.5602094240837696},{"x":0.5138888888888888,"y":0.5301047120418848},{"x":0.5166666666666667,"y":0.5091623036649214},{"x":0.5194444444444445,"y":0.49214659685863876},{"x":0.5229166666666667,"y":0.4829842931937173},{"x":0.525,"y":0.4790575916230366},{"x":0.5263888888888889,"y":0.47774869109947643},{"x":0.5277777777777778,"y":0.47643979057591623},{"x":0.5284722222222222,"y":0.47643979057591623},{"x":0.5291666666666667,"y":0.47643979057591623},{"x":0.5291666666666667,"y":0.47643979057591623},{"x":0.5291666666666667,"y":0.47643979057591623},{"x":0.5291666666666667,"y":0.47774869109947643},{"x":0.5291666666666667,"y":0.47774869109947643}]}],"settings":{"uniforms":{"uVertex":19,"uWidth":99.82545189406426,"uRadius":-0.034998145406090475,"uSpin":0.14668321742326412,"uBias":0.935617646315302,"uVertexHeight":0.38913958056061093,"uRotationSpeed":0.0018966275050258281,"uPointiness":0,"uPow":0.8320735372907312,"uPows":0,"uLr":0},"speed":3.219883640134607,"swatches":[{"swatch":["#C4BDAB","#AA996B","#A07E48","#8E652B","#8E5109","#913B00"],"seasonal":false,"label":"Brown","id":153},{"swatch":["#FFFB7D","#1E3EF9","#FFFB7D","#1E3EF9","#FFFB7D","#1E3EF9","#FFFB7D","#1E3EF9","#FFC476","#A917FF","#FFC476","#A917FF","#FFC476","#A917FF","#FFC476","#A917FF","#ABFC38","#D80090","#ABFC38","#D80090","#ABFC38","#D80090","#ABFC38","#D80090"],"seasonal":false,"label":"Multi Color","id":221}]},"hash":"","type":"video"}`

function VideoCard() {

  const [cData, setCData] = useState(testCData)
  const [renderId, setRenderId] = useState(null)
  const [startEndTimes, setStartEndTimes] = useState([])
  const [requestClicked, setRequestClicked] = useState(false)

  useEffect(() => {
    if (!requestClicked) {
      return
    }

    async function requestRender() {
      const resp = await fetch(`${REACT_APP_API_URL}/renderVideo`, {
        method: 'POST',
        headers: {
          'Accept': 'application/json',
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ cData })
      })
      const data = await resp.json()
      setRenderId( data.renderId )
      setStartEndTimes([ Date.now() ])
    }
    requestRender()
    setRequestClicked(false)
  }, [requestClicked])

  return (
      <div className="VideoCard">
        <div className="input-row">
          cData: <textarea value={cData}  onChange={(e) => setCData(e.target.value)} />
          <button className="request-render-button" 
            disabled={requestClicked || !!renderId}
            onClick={() => setRequestClicked(true)}>Request render</button>
        </div>

        {!!renderId &&
            <VideoFetcher
              renderId={renderId}
              onComplete={() => setStartEndTimes([ startEndTimes[0], Date.now() ]) }
              onCancel={() => setRenderId(null) }/>
        }
        
        { startEndTimes.length === 2 && <div> Complete time: { parseInt((startEndTimes[1] - startEndTimes[0])/1000 ) } sec </div> }
      </div>
  )
}

export default VideoCard
